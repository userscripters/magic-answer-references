// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Make referencing other answers easier
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/magic-answer-references#readme
// @match           https://*.stackexchange.com/questions/*
// @match           https://askubuntu.com/questions/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://mathoverflow.net/questions/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.superuser.com/questions/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://serverfault.com/questions/*
// @match           https://stackapps.com/questions/*
// @match           https://stackoverflow.com/questions/*
// @match           https://superuser.com/questions/*
// @name            Magic Answer References
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/magic-answer-references.git
// @supportURL      https://github.com/userscripters/magic-answer-references/issues
// @version         2.1.0
// ==/UserScript==

"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(t,i,c,s){return new(c=c||Promise)(function(n,e){function r(t){try{o(s.next(t))}catch(t){e(t)}}function a(t){try{o(s.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?n(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(r,a)}o((s=s.apply(t,i||[])).next())})},__generator=this&&this.__generator||function(r,a){var o,i,c,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(n){return function(t){var e=[n,t];if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(c=2&e[0]?i.return:e[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,e[1])).done)return c;switch(i=0,(e=c?[2&e[0],c.value]:e)[0]){case 0:case 1:c=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){s.label=e[1];break}if(6===e[0]&&s.label<c[1]){s.label=c[1],c=e;break}if(c&&s.label<c[2]){s.label=c[2],s.ops.push(e);break}c[2]&&s.ops.pop(),s.trys.pop();continue}e=a.call(r,s)}catch(t){e=[6,t],i=0}finally{o=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},__rest=this&&this.__rest||function(t,e){var n={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(n[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,a=Object.getOwnPropertySymbols(t);r<a.length;r++)e.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(t,a[r])&&(n[a[r]]=t[a[r]]);return n},__read=this&&this.__read||function(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,a,o=n.call(t),i=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)i.push(r.value)}catch(t){a={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return i},__spreadArray=this&&this.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var r,a=0,o=e.length;a<o;a++)!r&&a in e||((r=r||Array.prototype.slice.call(e,0,a))[a]=e[a]);return t.concat(r||Array.prototype.slice.call(e))},__values=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return{value:(t=t&&r>=t.length?void 0:t)&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var d,v,e,c,i,n,h,r,a,s,o,l,u,p,m,f,_,b,y,g,w,E,x,L,A,S,k,j,q,O,C,P,M,I,T;return __generator(this,function(t){switch(t.label){case 0:return(d="magic-answer-references",v="pkW3HOc0hP25As5oDPVYxg((",e=function(r,a){return void 0===a&&(a=document),new Promise(function(e){var t=a.querySelector(r),n=(t&&e(t),new MutationObserver(function(){var t=a.querySelector(r);t&&(n.disconnect(),e(t))}));n.observe(a,{subtree:!0,childList:!0,attributes:!0})})},c=function(t,e,n){var r=(n=void 0===n?{}:n).classes,r=void 0===r?[]:r,a=n.hidden,a=void 0!==a&&a,o=n.namespace,o=void 0===o?"http://www.w3.org/2000/svg":o,i=n.height,i=void 0===i?18:i,n=n.width,n=void 0===n?18:n,c=document.createElementNS(o,"svg"),s=((s=c.classList).add.apply(s,__spreadArray(["svg-icon",t],__read(r),!1)),c.setAttribute("width",n.toString()),c.setAttribute("height",i.toString()),c.setAttribute("viewBox","0 0 ".concat(n," ").concat(i)),c.setAttribute("aria-hidden","true"),a&&c.classList.add("d-none"),document.createElementNS(o,"path"));return s.setAttribute("d",e),c.append(s),c},i=function(c){document.addEventListener("dragstart",function(t){var t=t.dataTransfer,e=document.createElement("img");e.src="data:image/png;base64,AAAAAA==",null!=t&&t.setDragImage(e,0,0)});function e(t){var e,n,r,a,o=t.clientX,t=t.clientY,i=document.getElementById(c);i&&(s=s||o,d=d||t,e=(n=i.style).top,n=n.left,e||n||(e=(r=window.getComputedStyle(i)).top,n=r.left),[r=o-s,a=t-d].map(Math.abs).some(function(t){return 500<t})||((i=i.style).left="".concat(parseInt(n)+r,"px"),i.top="".concat(parseInt(e)+a,"px"),s=o,d=t))}var s=0,d=0,n=0,r=!1;document.addEventListener("dragstart",function(t){t.target===document.getElementById(c)&&(r=!0)}),document.addEventListener("dragend",function(t){t.target===document.getElementById(c)&&(r=!1,d=s=0)}),document.addEventListener("drag",function(t){if(!(3<=(n=t.clientX?0:n<3?n+1:3))&&r)return e(t)}),document.addEventListener("dragover",function(t){if(r&&t.preventDefault(),!(n<3)&&r)return e(t)})},n=function(t,e,n){var n=n.minWidth,r="modal-title",a=document.createElement("aside"),o=(a.classList.add("s-modal"),a.id=t,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",r),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a.dataset),o=(o.sModalTarget="modal",o.controller="s-modal",document.createElement("div")),n=(o.classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(n)),o.setAttribute("role","document"),o.id="".concat(t,"-document"),o.draggable=!0,document.createElement("h1")),t=(n.classList.add("s-modal--header"),n.id=r,n.textContent=e,document.createElement("form")),r=(t.classList.add("s-modal--body","d-flex","fd-column","flex__allcells6","fw-wrap","gs16"),document.createElement("button")),e=(r.classList.add("s-modal--close","s-btn","s-btn__muted"),r.type="button",r.dataset.action="s-modal#hide",c("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"));return i(o.id),r.append(e),o.append(n,t,r),a.append(o),a},h=function(t,e){var n=document.createElement("tr");return Object.assign(n.dataset,e||{}),n.append.apply(n,__spreadArray([],__read(t.map(function(t){var e=document.createElement("td");return e.append(t),e})),!1)),n},r=function(t,e){var n=e.classes,n=void 0===n?[]:n,r=e.headers,a=e.rows,a=void 0===a?[]:a,e=e.sortable,o=void 0!==e&&e,e=document.createElement("div"),i=((i=e.classList).add.apply(i,__spreadArray(["s-table-container"],__read(n),!1)),document.createElement("table")),n=(i.classList.add("s-table"),i.id=t,o&&(i.classList.add("s-table__sortable"),i.dataset.controller="s-table"),document.createElement("thead")),t=document.createElement("tr"),r=(t.append.apply(t,__spreadArray([],__read(r.map(function(t){var e,n,r=document.createElement("th");return r.scope="col",r.append(t),o&&((t=r.dataset).action="click->s-table#sort",t.sTableTarget="column",e=c("iconArrowUpDownSm","m7 2 4 4H3l4-4Zm0 10 4-4H3l4 4Z",__assign(__assign({},t={width:14,height:14}),{classes:["js-sorting-indicator","js-sorting-indicator-none"]})),n=c("iconArrowUpSm","M3 9h8L7 5 3 9Z",__assign(__assign({},t),{classes:["js-sorting-indicator","js-sorting-indicator-asc"],hidden:!0})),t=c("iconArrowDownSm","M3 5h8L7 9 3 5Z",__assign(__assign({},t),{classes:["js-sorting-indicator","js-sorting-indicator-desc"],hidden:!0})),r.append(e,n,t)),r})),!1)),document.createElement("tbody"));return r.append.apply(r,__spreadArray([],__read(a.map(function(t){var e=t.cells,t=t.data;return h(e,t)})),!1)),n.append(t),i.append(n,r),e.append(i),[e,i]},a=function(t,e){var n=(e=void 0===e?{}:e).classes,n=void 0===n?[]:n,r=e.placeholder,r=void 0===r?"":r,a=e.title,a=void 0===a?"":a,e=e.value,e=void 0===e?"":e,o=document.createElement("div"),i=((i=o.classList).add.apply(i,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(n),!1)),document.createElement("div")),n=(i.classList.add("d-flex","ps-relative"),document.createElement("input"));return n.classList.add("s-input"),n.id=t,n.type="text",n.placeholder=r,n.value=e,i.append(n),o.append(i),a?((r=document.createElement("div")).classList.add("flex--item"),(e=document.createElement("label")).classList.add("d-block","s-label"),e.htmlFor=t,e.textContent=a,r.append(e),o.prepend(r),[o,n,e]):[o,n]},s=function(t,e){var n=document.createElement("a");return n.href=t,n.title=n.textContent=e,n.target="_blank",n},o=function(){var t=document.createElement("style"),e=(document.head.append(t),t.sheet);e&&[".".concat(d,".wmd-button > .svg-icon {\n                margin-top: 2px;\n                color: var(--black-600);\n            }"),".".concat(d,".wmd-button > .svg-icon:hover {\n                color: var(--black-900);\n            }"),".".concat(d,".s-table-container td:first-child {\n                cursor: pointer;\n            }"),".".concat(d,".s-table-container thead {\n                position: sticky;\n                top: -1px;\n                z-index: 9999;\n            }"),".s-table td {\n                border-bottom: 1px solid var(--bc-medium);\n            }"].forEach(function(t){return e.insertRule(t)})},l=function(t,e,n){var n=void 0===n?{}:n,r=n.classes,r=void 0===r?[]:r,a=n.title,o=n.danger,o=void 0!==o&&o,i=n.loading,i=void 0!==i&&i,c=n.muted,c=void 0!==c&&c,s=n.primary,s=void 0!==s&&s,n=n.type,n=void 0===n?"filled":n,d=document.createElement("button");return d.id=t,d.textContent=e,(t=d.classList).add.apply(t,__spreadArray(["s-btn","s-btn__".concat(n)],__read(r),!1)),d.setAttribute("role","button"),d.setAttribute("aria-label",a||e),o&&d.classList.add("s-btn__danger"),c&&d.classList.add("s-btn__muted"),s&&d.classList.add("s-btn__primary"),i&&d.classList.add("is-loading"),a&&(d.title=a),d},u=function(t,e,n,r,a){var o=document.createElement("li");return o.classList.add("wmd-button",d),o.id=t,o.title=r,o.append(c(e,n)),o.addEventListener("click",a),o},p=function(t,e){var n=t.querySelector(".js-vote-count"),n=(null==(n=null==n?void 0:n.textContent)?void 0:n.trim())||"0",r=t.dataset,a=r.answerid,r=r.questionid,a="answer"===e?a:r;{if(a)return r={body:(null==(r=null==(r=t.querySelector(".js-post-body"))?void 0:r.textContent)?void 0:r.trim())||"",container:t,id:a,link:"".concat(location.origin,"/").concat("answer"===e?"a":"q","/").concat(a),type:e,votes:n},(a=t.querySelector("[itemprop=author] a"))&&(r.authorLink=a.href,r.authorName=null==(e=a.textContent)?void 0:e.trim()),a||(n=t.querySelector("[itemprop=name]"),r.authorName=null==(e=null==n?void 0:n.textContent)?void 0:e.trim()),r;console.debug("[".concat(d,"] post is missing an id"))}},m=function(){var e=new Map;return document.querySelectorAll(".answer").forEach(function(t){t=p(t,"answer");t&&e.set(t.id,t)}),document.querySelectorAll(".question").forEach(function(t){t=p(t,"question");t&&e.set(t.id,t)}),e},f=function(t,e){var n=t.selectionStart,r=t.selectionEnd,a=t.value,o=n===r,i=e.authorLink,c=e.authorName,s=e.link,e=e.type,n=a.slice(0,n+1),r=a.slice(r-1),i=i?"[".concat(c,"](").concat(i,")"):c,c="".concat(i?"".concat(i,"'s "):"","[").concat(e,"](").concat(s,")");t.value=o?a+c:n+c+r,t.dispatchEvent(new Event("input")),document.dispatchEvent(new CustomEvent("".concat(d,"-close-config")))},_=function(t){return __read(/^https:.+?\/q(?:uestions)?\/(\d+)(?:\/?\d*?$)/.exec(t)||[],2)[1]},b=function(t){var t=__read(/^https:.+?\/(?:a\/(\d+)(?:\/?\d*?$)|questions\/.+?\/(\d+))/.exec(t)||[],3),e=t[1],t=t[2];return e||t},y=new RegExp("^https:.+?\\/(?:q(?:uestions)?|a)\\/\\d+(?:\\/|$)"),g=function(t){return y.test(t)},w=function(t){t=__read(/^https:.+?\/([^\/]+)\//.exec(t)||[],2)[1].split(".").slice(0,-1).join(".");return"meta.stackexchange"!==t?t.replace(".stackexchange",""):t},E=function(e){return void 0===e&&(e=100),new Promise(function(t){return setTimeout(t,e)})},x=function(i,c){return __awaiter(void 0,void 0,void 0,function(){var e,n,r,t=c.site,a=void 0===t?"stackoverflow":t,o=__rest(c,["site"]);return __generator(this,function(t){switch(t.label){case 0:return(e=new URL("".concat("https://api.stackexchange.com","/").concat(2.3,"/posts/").concat(i))).search=new URLSearchParams(__assign({site:a},o)).toString(),[4,fetch(e.toString())];case 1:return(e=t.sent()).ok?[4,e.json()]:[2];case 2:return(r=t.sent(),n=r.items,n=void 0===n?[]:n,r=r.backoff)?[4,E(1e3*r)]:[3,4];case 3:return t.sent(),[2,x(i,__assign({site:a},o))];case 4:return[2,n[0]]}})})},L={classes:["s-btn__xs","w100"],type:"outlined",muted:!0},A=function(t,e){var n=e.authorName,r=e.authorLink,a=e.body,o=e.container,i=e.type,c=e.votes,r=r&&n?s(r,n):n||"",n=document.createElement("span"),i=(n.textContent=i,n.addEventListener("click",function(){var t,e,n,r;o&&(t=window.scrollX,e=window.scrollY,n=(r=o.getBoundingClientRect()).top,r=r.left,window.scrollTo(r+t,n+e))}),l("".concat(d,"-ref-").concat(t),"ref",L));return i.addEventListener("click",function(t){t.preventDefault(),f(k,e)}),{cells:[n,r,c,i],data:{body:a,id:t}}},document.getElementById("post-editor"))?[4,e("#wmd-button-row")]:(console.debug("[".concat(d,"] missing post editor")),[2]);case 1:return t.sent()?[4,e("#wmd-snippet-button")]:(console.debug("[".concat(d,"] missing editor menu")),[2]);case 2:return(S=t.sent())?[4,e("#wmd-input")]:(console.debug("[".concat(d,"] missing editor snippet button")),[2]);case 3:return(k=t.sent())?(j=n("".concat(d,"-config"),"Reference a Post",{minWidth:25}),(q=j.querySelector("form"))&&(T=m(),T=__read(r("".concat(d,"-current-posts"),{classes:[d,"hmx2"],headers:["Type","Author","Score","Actions"],rows:__spreadArray([],__read(T),!1).map(function(t){var t=__read(t,2),e=t[0],t=t[1];return A(e,t)}),sortable:!0}),2),O=T[0],C=T[1],T=__read(a("".concat(d,"-search"),{placeholder:"Post link or text to search for",title:"Post Search",classes:["m0","mt16"]}),2),P=T[0],M=T[1],I=new Map,M.addEventListener("input",function(){return __awaiter(void 0,void 0,void 0,function(){var e,n,r,a,o,i,c,s,d,l,u,p,m,f;return __generator(this,function(t){switch(t.label){case 0:return(e=M.value,g(e))?(n=_(e)||b(e))?I.get(n)?((r=C.querySelector("[data-id=".concat(n,"]")))&&(r.hidden=!1),[2]):[4,x(n,{site:w(e),filter:"7W_5I0m30",key:v})]:[2]:[3,2];case 1:return(r=t.sent())?(I.set(n,r),o=r.body,p=void 0===o?"":o,o=r.link,c=r.post_type,a=r.score,i=r.owner,o=A(n,{body:p,id:n,link:o,authorLink:null==i?void 0:i.link,authorName:null==i?void 0:i.display_name,type:c,votes:a.toString()}),i=o.cells,c=o.data,C.tBodies[0].append(h(i,c)),[2]):[2];case 2:s=C.rows;try{for(d=__values(s),l=d.next();!l.done;l=d.next())(u=l.value)!==s[0]&&(e?(p=u.dataset.body,u.hidden=!(null!=p&&p.toLowerCase().includes(e.toLowerCase()))):u.hidden=!1)}catch(t){m={error:t}}finally{try{l&&!l.done&&(f=d.return)&&f.call(d)}finally{if(m)throw m.error}}return[2]}})})}),q.append(O,P)),document.body.append(j),T=u("".concat(d,"-reference"),"iconMergeSm","M5.45 3H1v2h3.55l3.6 4-3.6 4H1v2h4.45l4.5-5H13v3l4-4-4-4v3H9.95l-4.5-5Z","Reference a post",function(){return Stacks.showModal(j)}),S.after(T),document.addEventListener("".concat(d,"-close-config"),function(){return Stacks.hideModal(j)}),o(),[2]):(console.debug("[".concat(d,"] missing editor input")),[2])}})})},{once:!0});