// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Make referencing other answers easier
// @grant           none
// @homepage        https://github.com/userscripters/magic-answer-references#readme
// @match           https://*.stackexchange.com/questions/*
// @match           https://askubuntu.com/questions/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://mathoverflow.net/questions/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.superuser.com/questions/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://serverfault.com/questions/*
// @match           https://stackapps.com/questions/*
// @match           https://stackoverflow.com/questions/*
// @match           https://superuser.com/questions/*
// @name            Magic Answer References
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/magic-answer-references.git
// @supportURL      https://github.com/userscripters/magic-answer-references/issues
// @version         0.1.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,c,i,d){return new(i=i||Promise)(function(n,t){function a(e){try{o(d.next(e))}catch(e){t(e)}}function r(e){try{o(d.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(a,r)}o((d=d.apply(e,c||[])).next())})},__generator=this&&this.__generator||function(a,r){var o,c,i,d={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;d;)try{if(o=1,c&&(i=2&t[0]?c.return:t[0]?c.throw||((i=c.return)&&i.call(c),0):c.next)&&!(i=i.call(c,t[1])).done)return i;switch(c=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return d.label++,{value:t[1],done:!1};case 5:d.label++,c=t[1],t=[0];continue;case 7:t=d.ops.pop(),d.trys.pop();continue;default:if(!(i=0<(i=d.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){d=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){d.label=t[1];break}if(6===t[0]&&d.label<i[1]){d.label=i[1],i=t;break}if(i&&d.label<i[2]){d.label=i[2],d.ops.push(t);break}i[2]&&d.ops.pop(),d.trys.pop();continue}t=r.call(a,d)}catch(e){t=[6,e],c=0}finally{o=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var a,r,o=n.call(e),c=[];try{for(;(void 0===t||0<t--)&&!(a=o.next()).done;)c.push(a.value)}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return c},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var a,r=0,o=t.length;r<o;r++)!a&&r in t||((a=a||Array.prototype.slice.call(t,0,r))[r]=t[r]);return e.concat(a||Array.prototype.slice.call(t))};window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var l,t,i,d,n,a,r,s,o,u,c,m,p,f,v,h,b,y,g,_,w,E;return __generator(this,function(e){switch(e.label){case 0:return(l="magic-answer-references",t=function(a,r){return void 0===r&&(r=document),new Promise(function(t){var e=r.querySelector(a),n=(e&&t(e),new MutationObserver(function(){var e=r.querySelector(a);e&&(n.disconnect(),t(e))}));n.observe(r,{subtree:!0,childList:!0,attributes:!0})})},i=function(e,t,n){void 0===n&&(n="http://www.w3.org/2000/svg");var a=document.createElementNS(n,"svg"),e=(a.classList.add("svg-icon",e),a.setAttribute("width","18"),a.setAttribute("height","18"),a.setAttribute("viewBox","0 0 18 18"),a.setAttribute("aria-hidden","true"),document.createElementNS(n,"path"));return e.setAttribute("d",t),a.append(e),a},d=function(i){document.addEventListener("dragstart",function(e){var e=e.dataTransfer,t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});function t(e){var t,n,a,r,o=e.clientX,e=e.clientY,c=document.getElementById(i);c&&(d=d||o,s=s||e,t=(n=c.style).top,n=n.left,t||n||(t=(a=window.getComputedStyle(c)).top,n=a.left),[a=o-d,r=e-s].map(Math.abs).some(function(e){return 500<e})||((c=c.style).left="".concat(parseInt(n)+a,"px"),c.top="".concat(parseInt(t)+r,"px"),d=o,s=e))}var d=0,s=0,n=0,a=!1;document.addEventListener("dragstart",function(e){e.target===document.getElementById(i)&&(a=!0)}),document.addEventListener("dragend",function(e){e.target===document.getElementById(i)&&(a=!1,s=d=0)}),document.addEventListener("drag",function(e){if(!(3<=(n=e.clientX?0:n<3?n+1:3))&&a)return t(e)}),document.addEventListener("dragover",function(e){if(a&&e.preventDefault(),!(n<3)&&a)return t(e)})},n=function(e,t,n){var n=n.minWidth,a="modal-title",r=document.createElement("aside"),o=(r.classList.add("s-modal"),r.id=e,r.tabIndex=-1,r.setAttribute("role","dialog"),r.setAttribute("aria-labelledby",a),r.setAttribute("aria-describeddy","modal-description"),r.setAttribute("aria-hidden","true"),r.dataset),o=(o.sModalTarget="modal",o.controller="s-modal",document.createElement("div")),n=(o.classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(n)),o.setAttribute("role","document"),o.id="".concat(e,"-document"),o.draggable=!0,document.createElement("h1")),a=(n.classList.add("s-modal--header"),n.id=a,n.textContent=t,document.createElement("form")),t=(a.classList.add("s-modal--body","d-flex","fd-column","flex__allcells6","fw-wrap","gs16"),document.createElement("button")),c=(t.classList.add("s-modal--close","s-btn","s-btn__muted"),t.type="button",t.dataset.action="s-modal#hide",i("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"));return d(e),t.append(c),o.append(n,a,t),r.append(o),r},a=function(e,t){var n=t.headers,t=t.cellGrid,t=void 0===t?[]:t,a=document.createElement("div"),r=(a.classList.add("s-table-container"),document.createElement("table")),e=(r.classList.add("s-table"),r.id=e,document.createElement("thead")),o=document.createElement("tr"),n=(o.append.apply(o,__spreadArray([],__read(n.map(function(e){var t=document.createElement("th");return t.scope="col",t.append(e),t})),!1)),document.createElement("tbody"));return n.append.apply(n,__spreadArray([],__read(t.map(function(e){var t=document.createElement("tr");return t.append.apply(t,__spreadArray([],__read(e.map(function(e){var t=document.createElement("td");return t.append(e),t})),!1)),t})),!1)),e.append(o),r.append(e,n),a.append(r),a},r=function(e,t){var n=(t=void 0===t?{}:t).classes,n=void 0===n?[]:n,a=t.placeholder,a=void 0===a?"":a,r=t.title,r=void 0===r?"":r,t=t.value,t=void 0===t?"":t,o=document.createElement("div"),c=((c=o.classList).add.apply(c,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(n),!1)),document.createElement("div")),n=(c.classList.add("d-flex","ps-relative"),document.createElement("input"));return n.classList.add("s-input"),n.id=e,n.type="text",n.placeholder=a,n.value=t,c.append(n),o.append(c),r?((a=document.createElement("div")).classList.add("flex--item"),(t=document.createElement("label")).classList.add("d-block","s-label"),t.htmlFor=e,t.textContent=r,a.append(t),o.prepend(a),[o,n,t]):[o,n]},s=function(e,t){var n=document.createElement("a");return n.href=e,n.title=n.textContent=t,n.target="_blank",n},o=function(){var e=document.createElement("style"),t=(document.head.append(e),e.sheet);t&&[".".concat(l,".wmd-button > .svg-icon {\n                margin-top: 2px;\n                color: var(--black-600);\n            }"),".".concat(l,".wmd-button > .svg-icon:hover {\n                color: var(--black-900);\n            }")].forEach(function(e){return t.insertRule(e)})},u=function(e,t,n){var n=void 0===n?{}:n,a=n.classes,a=void 0===a?[]:a,r=n.title,o=n.danger,o=void 0!==o&&o,c=n.loading,c=void 0!==c&&c,i=n.muted,i=void 0!==i&&i,d=n.primary,d=void 0!==d&&d,n=n.type,n=void 0===n?"filled":n,s=document.createElement("button");return s.id=e,s.textContent=t,(e=s.classList).add.apply(e,__spreadArray(["s-btn","s-btn__".concat(n)],__read(a),!1)),s.setAttribute("role","button"),s.setAttribute("aria-label",r||t),o&&s.classList.add("s-btn__danger"),i&&s.classList.add("s-btn__muted"),d&&s.classList.add("s-btn__primary"),c&&s.classList.add("is-loading"),r&&(s.title=r),s},c=function(e,t,n,a,r){var o=document.createElement("li");return o.classList.add("wmd-button",l),o.id=e,o.title=a,o.append(i(t,n)),o.addEventListener("click",r),o},m=function(e,t){var n=e.querySelector(".js-vote-count"),n=(null==(n=null==n?void 0:n.textContent)?void 0:n.trim())||"0",a=e.dataset,r=a.answerid,a=a.questionid,r="answer"===t?r:a;{if(r)return a={container:e,id:r,type:t,votes:n},(r=e.querySelector("[itemprop=author] a"))&&(a.authorLink=r.href,a.authorName=null==(t=r.textContent)?void 0:t.trim()),r||(n=e.querySelector("[itemprop=name]"),a.authorName=null==(t=null==n?void 0:n.textContent)?void 0:t.trim()),a;console.debug("[".concat(l,"] post is missing an id"))}},p=function(){var t=new Map;return document.querySelectorAll(".answer").forEach(function(e){e=m(e,"answer");e&&t.set(e.id,e)}),document.querySelectorAll(".question").forEach(function(e){e=m(e,"question");e&&t.set(e.id,e)}),t},f=function(e,t){var n=e.selectionStart,a=e.selectionEnd,r=e.value,o=n===a,c=t.authorLink,i=t.authorName,d=t.id,t=t.type,n=r.slice(0,n+1),a=r.slice(a-1),s="answer"===t?"a":"q",s="https://".concat(location.origin,"/").concat(s,"/").concat(d),d=c?"[".concat(i,"](").concat(c,")"):i,c="".concat(d?"".concat(d,"'s "):"","[").concat(t,"](").concat(s,")");e.value=o?r+c:n+c+a,e.dispatchEvent(new Event("input")),document.dispatchEvent(new CustomEvent("".concat(l,"-close-config")))},document.getElementById("post-editor"))?[4,t("#wmd-button-row")]:(console.debug("[".concat(l,"] missing post editor")),[2]);case 1:return e.sent()?[4,t("#wmd-snippet-button")]:(console.debug("[".concat(l,"] missing editor menu")),[2]);case 2:return(v=e.sent())?[4,t("#wmd-input")]:(console.debug("[".concat(l,"] missing editor snippet button")),[2]);case 3:return(h=e.sent())?(b=n("".concat(l,"-config"),"Reference a Post",{minWidth:25}),(y=b.querySelector("form"))&&(_=p(),g={classes:["s-btn__xs","w100"],type:"outlined",muted:!0},_=a("".concat(l,"-current-posts"),{headers:["Type","Author","Votes","Actions"],cellGrid:__spreadArray([],__read(_),!1).map(function(e){var e=__read(e,2),t=e[0],n=e[1],e=n.authorName,a=n.authorLink,r=n.container,o=n.type,c=n.votes,a=a&&e?s(a,e):e||"",e=document.createElement("span"),o=(e.textContent=o,e.addEventListener("click",function(){var e=window.scrollX,t=window.scrollY,n=r.getBoundingClientRect(),a=n.top,n=n.left;window.scrollTo(n+e,a+t)}),u("".concat(l,"-ref-").concat(t),"ref",g));return o.addEventListener("click",function(e){e.preventDefault(),f(h,n)}),[e,a,c,o]})}),E=__read(r("".concat(l,"-search"),{placeholder:"Post link or text to search for",title:"Post Search",classes:["m0","mt12"]}),2),w=E[0],E[1].addEventListener("change",function(){}),y.append(_,w)),document.body.append(b),(E=c("".concat(l,"-reference"),"iconMergeSm","M5.45 3H1v2h3.55l3.6 4-3.6 4H1v2h4.45l4.5-5H13v3l4-4-4-4v3H9.95l-4.5-5Z","Reference a post",function(){})).addEventListener("click",function(){return Stacks.showModal(b)}),v.after(E),document.addEventListener("".concat(l,"-close-config"),function(){return Stacks.hideModal(b)}),o(),[2]):(console.debug("[".concat(l,"] missing editor input")),[2])}})})},{once:!0});