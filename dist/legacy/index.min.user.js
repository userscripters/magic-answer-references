// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Make referencing other answers easier
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/magic-answer-references#readme
// @match           https://*.stackexchange.com/questions/*
// @match           https://askubuntu.com/questions/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://mathoverflow.net/questions/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.superuser.com/questions/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://serverfault.com/questions/*
// @match           https://stackapps.com/questions/*
// @match           https://stackoverflow.com/questions/*
// @match           https://superuser.com/questions/*
// @name            Magic Answer References
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/magic-answer-references.git
// @supportURL      https://github.com/userscripters/magic-answer-references/issues
// @version         2.0.0
// ==/UserScript==

"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,c,i,s){return new(i=i||Promise)(function(n,t){function r(e){try{o(s.next(e))}catch(e){t(e)}}function a(e){try{o(s.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(r,a)}o((s=s.apply(e,c||[])).next())})},__generator=this&&this.__generator||function(r,a){var o,c,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,c&&(i=2&t[0]?c.return:t[0]?c.throw||((i=c.return)&&i.call(c),0):c.next)&&!(i=i.call(c,t[1])).done)return i;switch(c=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,c=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){s.label=t[1];break}if(6===t[0]&&s.label<i[1]){s.label=i[1],i=t;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(t);break}i[2]&&s.ops.pop(),s.trys.pop();continue}t=a.call(r,s)}catch(e){t=[6,e],c=0}finally{o=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__rest=this&&this.__rest||function(e,t){var n={};for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,a=Object.getOwnPropertySymbols(e);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(e,a[r])&&(n[a[r]]=e[a[r]]);return n},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),c=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)c.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return c},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,o=t.length;a<o;a++)!r&&a in t||((r=r||Array.prototype.slice.call(t,0,a))[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var d,t,c,i,n,_,r,a,s,o,l,u,p,m,f,b,g,v,w,E,h,x,y,L,S,A,k,q,R,C,T,O,P,j,I,M,H,B,N;return __generator(this,function(e){switch(e.label){case 0:return(d="magic-answer-references",t=function(r,a){return void 0===a&&(a=document),new Promise(function(t){var e=a.querySelector(r),n=(e&&t(e),new MutationObserver(function(){var e=a.querySelector(r);e&&(n.disconnect(),t(e))}));n.observe(a,{subtree:!0,childList:!0,attributes:!0})})},c=function(e,t,n){void 0===n&&(n="http://www.w3.org/2000/svg");var r=document.createElementNS(n,"svg"),e=(r.classList.add("svg-icon",e),r.setAttribute("width","18"),r.setAttribute("height","18"),r.setAttribute("viewBox","0 0 18 18"),r.setAttribute("aria-hidden","true"),document.createElementNS(n,"path"));return e.setAttribute("d",t),r.append(e),r},i=function(i){document.addEventListener("dragstart",function(e){var e=e.dataTransfer,t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});function t(e){var t,n,r,a,o=e.clientX,e=e.clientY,c=document.getElementById(i);c&&(s=s||o,d=d||e,t=(n=c.style).top,n=n.left,t||n||(t=(r=window.getComputedStyle(c)).top,n=r.left),[r=o-s,a=e-d].map(Math.abs).some(function(e){return 500<e})||((c=c.style).left="".concat(parseInt(n)+r,"px"),c.top="".concat(parseInt(t)+a,"px"),s=o,d=e))}var s=0,d=0,n=0,r=!1;document.addEventListener("dragstart",function(e){e.target===document.getElementById(i)&&(r=!0)}),document.addEventListener("dragend",function(e){e.target===document.getElementById(i)&&(r=!1,d=s=0)}),document.addEventListener("drag",function(e){if(!(3<=(n=e.clientX?0:n<3?n+1:3))&&r)return t(e)}),document.addEventListener("dragover",function(e){if(r&&e.preventDefault(),!(n<3)&&r)return t(e)})},n=function(e,t,n){var n=n.minWidth,r="modal-title",a=document.createElement("aside"),o=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",r),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a.dataset),o=(o.sModalTarget="modal",o.controller="s-modal",document.createElement("div")),n=(o.classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(n)),o.setAttribute("role","document"),o.id="".concat(e,"-document"),o.draggable=!0,document.createElement("h1")),e=(n.classList.add("s-modal--header"),n.id=r,n.textContent=t,document.createElement("form")),r=(e.classList.add("s-modal--body","d-flex","fd-column","flex__allcells6","fw-wrap","gs16"),document.createElement("button")),t=(r.classList.add("s-modal--close","s-btn","s-btn__muted"),r.type="button",r.dataset.action="s-modal#hide",c("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"));return i(o.id),r.append(t),o.append(n,e,r),a.append(o),a},_=function(e,t){var n=document.createElement("tr");return Object.assign(n.dataset,t||{}),n.append.apply(n,__spreadArray([],__read(e.map(function(e){var t=document.createElement("td");return t.append(e),t})),!1)),n},r=function(e,t){var n=t.classes,n=void 0===n?[]:n,r=t.headers,t=t.rows,t=void 0===t?[]:t,a=document.createElement("div"),o=((o=a.classList).add.apply(o,__spreadArray(["s-table-container"],__read(n),!1)),document.createElement("table")),n=(o.classList.add("s-table"),o.id=e,document.createElement("thead")),e=document.createElement("tr"),r=(e.append.apply(e,__spreadArray([],__read(r.map(function(e){var t=document.createElement("th");return t.scope="col",t.append(e),t})),!1)),document.createElement("tbody"));return r.append.apply(r,__spreadArray([],__read(t.map(function(e){var t=e.cells,e=e.data;return _(t,e)})),!1)),n.append(e),o.append(n,r),a.append(o),[a,o]},a=function(e,t){var n=(t=void 0===t?{}:t).classes,n=void 0===n?[]:n,r=t.placeholder,r=void 0===r?"":r,a=t.title,a=void 0===a?"":a,t=t.value,t=void 0===t?"":t,o=document.createElement("div"),c=((c=o.classList).add.apply(c,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(n),!1)),document.createElement("div")),n=(c.classList.add("d-flex","ps-relative"),document.createElement("input"));return n.classList.add("s-input"),n.id=e,n.type="text",n.placeholder=r,n.value=t,c.append(n),o.append(c),a?((r=document.createElement("div")).classList.add("flex--item"),(t=document.createElement("label")).classList.add("d-block","s-label"),t.htmlFor=e,t.textContent=a,r.append(t),o.prepend(r),[o,n,t]):[o,n]},s=function(e,t){var n=document.createElement("a");return n.href=e,n.title=n.textContent=t,n.target="_blank",n},o=function(){var e=document.createElement("style"),t=(document.head.append(e),e.sheet);t&&[".".concat(d,".wmd-button > .svg-icon {\n                margin-top: 2px;\n                color: var(--black-600);\n            }"),".".concat(d,".wmd-button > .svg-icon:hover {\n                color: var(--black-900);\n            }"),".".concat(d,".s-table-container td:first-child {\n                cursor: pointer;\n            }"),".".concat(d,".s-table-container thead {\n                position: sticky;\n                top: -1px;\n                z-index: 9999;\n            }"),".s-table td {\n                border-bottom: 1px solid var(--bc-medium);\n            }"].forEach(function(e){return t.insertRule(e)})},l=function(e,t,n){var n=void 0===n?{}:n,r=n.classes,r=void 0===r?[]:r,a=n.title,o=n.danger,o=void 0!==o&&o,c=n.loading,c=void 0!==c&&c,i=n.muted,i=void 0!==i&&i,s=n.primary,s=void 0!==s&&s,n=n.type,n=void 0===n?"filled":n,d=document.createElement("button");return d.id=e,d.textContent=t,(e=d.classList).add.apply(e,__spreadArray(["s-btn","s-btn__".concat(n)],__read(r),!1)),d.setAttribute("role","button"),d.setAttribute("aria-label",a||t),o&&d.classList.add("s-btn__danger"),i&&d.classList.add("s-btn__muted"),s&&d.classList.add("s-btn__primary"),c&&d.classList.add("is-loading"),a&&(d.title=a),d},u=function(e,t,n,r,a){var o=document.createElement("li");return o.classList.add("wmd-button",d),o.id=e,o.title=r,o.append(c(t,n)),o.addEventListener("click",a),o},p=function(e,t){var n=e.querySelector(".js-vote-count"),n=(null==(n=null==n?void 0:n.textContent)?void 0:n.trim())||"0",r=e.dataset,a=r.answerid,r=r.questionid,a="answer"===t?a:r;{if(a)return r={body:(null==(r=null==(r=e.querySelector(".js-post-body"))?void 0:r.textContent)?void 0:r.trim())||"",container:e,id:a,link:"".concat(location.origin,"/").concat("answer"===t?"a":"q","/").concat(a),type:t,votes:n},(a=e.querySelector("[itemprop=author] a"))&&(r.authorLink=a.href,r.authorName=null==(t=a.textContent)?void 0:t.trim()),a||(n=e.querySelector("[itemprop=name]"),r.authorName=null==(t=null==n?void 0:n.textContent)?void 0:t.trim()),r;console.debug("[".concat(d,"] post is missing an id"))}},m=function(){var t=new Map;return document.querySelectorAll(".answer").forEach(function(e){e=p(e,"answer");e&&t.set(e.id,e)}),document.querySelectorAll(".question").forEach(function(e){e=p(e,"question");e&&t.set(e.id,e)}),t},f=function(e,t){var n=e.selectionStart,r=e.selectionEnd,a=e.value,o=n===r,c=t.authorLink,i=t.authorName,s=t.link,t=t.type,n=a.slice(0,n+1),r=a.slice(r-1),c=c?"[".concat(i,"](").concat(c,")"):i,i="".concat(c?"".concat(c,"'s "):"","[").concat(t,"](").concat(s,")");e.value=o?a+i:n+i+r,e.dispatchEvent(new Event("input")),document.dispatchEvent(new CustomEvent("".concat(d,"-close-config")))},b=function(e){return __read(/^https:.+?\/q(?:uestions)?\/(\d+)(?:\/?\d*?$)/.exec(e)||[],2)[1]},g=function(e){var e=__read(/^https:.+?\/(?:a\/(\d+)(?:\/?\d*?$)|questions\/.+?\/(\d+))/.exec(e)||[],3),t=e[1],e=e[2];return t||e},v=new RegExp("^https:.+?\\/(?:q(?:uestions)?|a)\\/\\d+(?:\\/|$)"),w=function(e){return v.test(e)},E=function(e){e=__read(/^https:.+?\/([^\/]+)\//.exec(e)||[],2)[1].split(".").slice(0,-1).join(".");return"meta.stackexchange"!==e?e.replace(".stackexchange",""):e},h=function(t){return void 0===t&&(t=100),new Promise(function(e){return setTimeout(e,t)})},x=function(c,i){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,e=i.site,a=void 0===e?"stackoverflow":e,o=__rest(i,["site"]);return __generator(this,function(e){switch(e.label){case 0:return(t=new URL("".concat("https://api.stackexchange.com","/").concat(2.3,"/posts/").concat(c))).search=new URLSearchParams(__assign({site:a},o)).toString(),[4,fetch(t.toString())];case 1:return(t=e.sent()).ok?[4,t.json()]:[2];case 2:return(r=e.sent(),n=r.items,n=void 0===n?[]:n,r=r.backoff)?[4,h(1e3*r)]:[3,4];case 3:return e.sent(),[2,x(c,__assign({site:a},o))];case 4:return[2,n[0]]}})})},y={classes:["s-btn__xs","w100"],type:"outlined",muted:!0},L=function(e,t){var n=t.authorName,r=t.authorLink,a=t.body,o=t.container,c=t.type,i=t.votes,r=r&&n?s(r,n):n||"",n=document.createElement("span"),c=(n.textContent=c,n.addEventListener("click",function(){var e,t,n,r;o&&(e=window.scrollX,t=window.scrollY,n=(r=o.getBoundingClientRect()).top,r=r.left,window.scrollTo(r+e,n+t))}),l("".concat(d,"-ref-").concat(e),"ref",y));return c.addEventListener("click",function(e){e.preventDefault(),f(A,t)}),{cells:[n,r,i,c],data:{body:a,id:e}}},document.getElementById("post-editor"))?[4,t("#wmd-button-row")]:(console.debug("[".concat(d,"] missing post editor")),[2]);case 1:return e.sent()?[4,t("#wmd-snippet-button")]:(console.debug("[".concat(d,"] missing editor menu")),[2]);case 2:return(S=e.sent())?[4,t("#wmd-input")]:(console.debug("[".concat(d,"] missing editor snippet button")),[2]);case 3:return(A=e.sent())?(k=n("".concat(d,"-config"),"Reference a Post",{minWidth:25}),(q=k.querySelector("form"))?(M=m(),M=__read(r("".concat(d,"-current-posts"),{classes:[d,"hmx2"],headers:["Type","Author","Score","Actions"],rows:__spreadArray([],__read(M),!1).map(function(e){var e=__read(e,2),t=e[0],e=e[1];return L(t,e)})}),2),R=M[0],C=M[1],M=__read(a("".concat(d,"-search"),{placeholder:"Post link or text to search for",title:"Post Search",classes:["m0","mt16"]}),2),T=M[0],O=M[1],M=Store.locateStorage(),P=new Store.default(d,M),j="se-api-key",[4,P.load(j,"")]):[3,6]):(console.debug("[".concat(d,"] missing editor input")),[2]);case 4:return I=e.sent(),[4,P.save(j,I)];case 5:e.sent(),M=__read(a("".concat(d,"-").concat(j),{placeholder:"SE API key (advanced search)",title:"API Key",classes:["m0","mt16"],value:I}),2),N=M[0],(H=M[1]).addEventListener("change",function(){return P.save(j,H.value)}),B=new Map,O.addEventListener("input",function(){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,a,o,c,i,s,d,l,u,p,m,f,v,h,y;return __generator(this,function(e){switch(e.label){case 0:return(t=O.value,w(t))?(n=b(t)||g(t))?B.get(n)?((r=C.querySelector("[data-id=".concat(n,"]")))&&(r.hidden=!1),[2]):(a=x,o=[n],v={site:E(t),filter:"7W_5I0m30"},[4,P.load(j,I)]):[2]:[3,3];case 1:return[4,a.apply(void 0,o.concat([(v.key=e.sent(),v)]))];case 2:return(r=e.sent())?(B.set(n,r),i=r.body,f=void 0===i?"":i,i=r.link,d=r.post_type,c=r.score,s=r.owner,i=L(n,{body:f,id:n,link:i,authorLink:null==s?void 0:s.link,authorName:null==s?void 0:s.display_name,type:d,votes:c.toString()}),s=i.cells,d=i.data,C.tBodies[0].append(_(s,d)),[2]):[2];case 3:l=C.rows;try{for(u=__values(l),p=u.next();!p.done;p=u.next())(m=p.value)!==l[0]&&(t?(f=m.dataset.body,m.hidden=!(null!=f&&f.toLowerCase().includes(t.toLowerCase()))):m.hidden=!1)}catch(e){h={error:e}}finally{try{p&&!p.done&&(y=u.return)&&y.call(u)}finally{if(h)throw h.error}}return[2]}})})}),q.append(R,T,N),e.label=6;case 6:return document.body.append(k),N=u("".concat(d,"-reference"),"iconMergeSm","M5.45 3H1v2h3.55l3.6 4-3.6 4H1v2h4.45l4.5-5H13v3l4-4-4-4v3H9.95l-4.5-5Z","Reference a post",function(){return Stacks.showModal(k)}),S.after(N),document.addEventListener("".concat(d,"-close-config"),function(){return Stacks.hideModal(k)}),o(),[2]}})})},{once:!0});