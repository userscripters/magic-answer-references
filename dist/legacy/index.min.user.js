// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Make referencing other answers easier
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/magic-answer-references#readme
// @match           https://*.stackexchange.com/questions/*
// @match           https://askubuntu.com/questions/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://mathoverflow.net/questions/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.superuser.com/questions/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://serverfault.com/questions/*
// @match           https://stackapps.com/questions/*
// @match           https://stackoverflow.com/questions/*
// @match           https://superuser.com/questions/*
// @name            Magic Answer References
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/magic-answer-references.git
// @supportURL      https://github.com/userscripters/magic-answer-references/issues
// @version         2.2.0
// ==/UserScript==

"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,i,s,c){return new(s=s||Promise)(function(n,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function a(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,a)}o((c=c.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(r,a){var o,i,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,i=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){c.label=t[1];break}if(6===t[0]&&c.label<s[1]){c.label=s[1],s=t;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(t);break}s[2]&&c.ops.pop(),c.trys.pop();continue}t=a.call(r,c)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__rest=this&&this.__rest||function(e,t){var n={};for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,a=Object.getOwnPropertySymbols(e);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(e,a[r])&&(n[a[r]]=e[a[r]]);return n},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)i.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return i},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,o=t.length;a<o;a++)!r&&a in t||((r=r||Array.prototype.slice.call(t,0,a))[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))};window.addEventListener("load",function(){function l(r,a){return void 0===a&&(a=document),new Promise(function(t){var e=a.querySelector(r),n=(e&&t(e),new MutationObserver(function(){var e=a.querySelector(r);e&&(n.disconnect(),t(e))}));n.observe(a,{subtree:!0,childList:!0,attributes:!0})})}function r(e){return!!e}function e(s){function t(e){var t,n,r,a,o=e.clientX,e=e.clientY,i=document.getElementById(s);i&&(c=c||o,d=d||e,t=(n=i.style).top,n=n.left,t||n||(t=(r=window.getComputedStyle(i)).top,n=r.left),[r=o-c,a=e-d].map(Math.abs).some(function(e){return 500<e})||((i=i.style).left="".concat(parseInt(n)+r,"px"),i.top="".concat(parseInt(t)+a,"px"),c=o,d=e))}document.addEventListener("dragstart",function(e){var e=e.dataTransfer,t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});var c=0,d=0,n=0,r=!1;document.addEventListener("dragstart",function(e){e.target===document.getElementById(s)&&(r=!0)}),document.addEventListener("dragend",function(e){e.target===document.getElementById(s)&&(r=!1,d=c=0)}),document.addEventListener("drag",function(e){if(!(3<=(n=e.clientX?0:n<3?n+1:3))&&r)return t(e)}),document.addEventListener("dragover",function(e){if(r&&e.preventDefault(),!(n<3)&&r)return t(e)})}function _(e,t){var n=document.createElement("tr");return Object.assign(n.dataset,t||{}),n.append.apply(n,__spreadArray([],__read(e.map(function(e){var t=document.createElement("td");return t.append(e),t})),!1)),n}function t(e,t){var n=(null==(n=null==(n=e.querySelector(".js-vote-count"))?void 0:n.textContent)?void 0:n.trim())||"0",r=(a=e.dataset).answerid,a=a.questionid;if(r="answer"===t?r:a)return a={body:(null==(a=null==(a=e.querySelector(".js-post-body"))?void 0:a.textContent)?void 0:a.trim())||"",container:e,id:r,link:"".concat(location.origin,"/").concat("answer"===t?"a":"q","/").concat(r),type:t,votes:n},(r=e.querySelector("[itemprop=author] a"))&&(a.authorLink=r.href,a.authorName=null==(t=r.textContent)?void 0:t.trim()),r||(n=e.querySelector("[itemprop=name]"),a.authorName=null==(t=null==n?void 0:n.textContent)?void 0:t.trim()),a;console.debug("[".concat(x,"] post is missing an id"))}function b(s,t){return __awaiter(void 0,void 0,void 0,function(){var n,r,a,e=t.site,o=void 0===e?"stackoverflow":e,i=__rest(t,["site"]);return __generator(this,function(e){switch(e.label){case 0:return(n=new URL("".concat("https://api.stackexchange.com","/").concat(2.3,"/posts/").concat(s))).search=new URLSearchParams(__assign({site:o},i)).toString(),[4,fetch(n.toString())];case 1:return(n=e.sent()).ok?[4,n.json()]:[2];case 2:return(a=e.sent(),r=a.items,r=void 0===r?[]:r,a=a.backoff)?[4,(void 0===(t=1e3*a)&&(t=100),new Promise(function(e){return setTimeout(e,t)}))]:[3,4];case 3:return e.sent(),[2,b(s,__assign({site:o},i))];case 4:return[2,r[0]]}var t})})}function y(l,e,u){var t,n,r,a,o,i,s,c,d=u.authorName,p=u.authorLink,m=u.body,f=u.container,v=u.type,h=u.votes,p=p&&d?(p=p,_=d,(t=document.createElement("a")).href=p,t.title=t.textContent=_,t.target="_blank",t):d||"",_=document.createElement("span");return _.textContent=v,_.addEventListener("click",function(){var e,t,n,r;f&&(e=window.scrollX,t=window.scrollY,n=(r=f.getBoundingClientRect()).top,r=r.left,window.scrollTo(r+e,n+t))}),t="".concat(x,"-ref-").concat(e),d="ref",n=void 0===(n=(v=void 0===(v=S)?{}:v).classes)?[]:n,r=v.title,a=void 0!==(a=v.danger)&&a,o=void 0!==(o=v.loading)&&o,i=void 0!==(i=v.muted)&&i,s=void 0!==(s=v.primary)&&s,v=void 0===(v=v.type)?"filled":v,(c=document.createElement("button")).id=t,c.textContent=d,(t=c.classList).add.apply(t,__spreadArray(["s-btn","s-btn__".concat(v)],__read(n),!1)),c.setAttribute("role","button"),c.setAttribute("aria-label",r||d),a&&c.classList.add("s-btn__danger"),i&&c.classList.add("s-btn__muted"),s&&c.classList.add("s-btn__primary"),o&&c.classList.add("is-loading"),r&&(c.title=r),(v=c).addEventListener("click",function(e){e.preventDefault();var t,n,r,a,o,i,s,c,d,e=l.dataset.currentEditorId;e?(t=document.getElementById(e))&&((n=t.querySelector(".js-post-body-field"))?(r=u,a=(n=n).selectionStart,o=n.selectionEnd,i=n.value,s=u.authorLink,c=u.authorName,d=u.link,r=u.type,a=i.slice(0,a),i=i.slice(o),o=s?"[".concat(c,"](").concat(s,")"):c,s="".concat(o?"".concat(o,"'s "):"","[").concat(r,"](").concat(d,")"),n.value=a+s+i,n.dispatchEvent(new Event("input")),document.dispatchEvent(new CustomEvent("".concat(x,"-close-config")))):console.debug("[".concat(x,"] missing editor input (").concat(t,")"))):console.debug("[".concat(x,"] missing editor (").concat(e,")"))}),{cells:[_,p,h,v],data:{body:m,id:e}}}function a(d){return __awaiter(void 0,void 0,void 0,function(){var s,c;return __generator(this,function(e){switch(e.label){case 0:return d?[4,l(".wmd-button-row",d)]:(console.debug("[".concat(x,"] missing post editor")),[2]);case 1:return e.sent()?[4,l(".wmd-snippet-button",d)]:(console.debug("[".concat(x,"] missing editor menu")),[2]);case 2:return(s=e.sent())?(t="".concat(x,"-reference"),n="iconMergeSm",r="M5.45 3H1v2h3.55l3.6 4-3.6 4H1v2h4.45l4.5-5H13v3l4-4-4-4v3H9.95l-4.5-5Z",a="Reference a post",o=function(){A.dataset.currentEditorId=d.id,Stacks.showModal(A)},(i=document.createElement("li")).classList.add("wmd-button",x),i.id=t,i.title=a,i.append(v(n,r)),i.addEventListener("click",o),c=i,s.after(c),[2]):(console.debug("[".concat(x,"] missing editor snippet button")),[2])}var t,n,r,a,o,i})})}var g,w,E,n,o,i,s,c,d,u,p,m,f,x="magic-answer-references",v=function(e,t,n){var r=(n=void 0===n?{}:n).classes,r=void 0===r?[]:r,a=n.hidden,a=void 0!==a&&a,o=n.namespace,o=void 0===o?"http://www.w3.org/2000/svg":o,i=n.height,i=void 0===i?18:i,n=n.width,n=void 0===n?18:n,s=document.createElementNS(o,"svg"),c=((c=s.classList).add.apply(c,__spreadArray(["svg-icon",e],__read(r),!1)),s.setAttribute("width",n.toString()),s.setAttribute("height",i.toString()),s.setAttribute("viewBox","0 0 ".concat(n," ").concat(i)),s.setAttribute("aria-hidden","true"),a&&s.classList.add("d-none"),document.createElementNS(o,"path"));return c.setAttribute("d",t),s.append(c),s},L=new RegExp("^https:.+?\\/(?:q(?:uestions)?|a)\\/\\d+(?:\\/|$)"),S={classes:["s-btn__xs","w100"],type:"outlined",muted:!0},h=document.getElementById("post-editor"),A=(a(h),h="".concat(x,"-config"),k="Reference a Post",m=(m={minWidth:25}).minWidth,i="modal-title",(c=document.createElement("aside")).classList.add("s-modal"),c.id=h,c.tabIndex=-1,c.setAttribute("role","dialog"),c.setAttribute("aria-labelledby",i),c.setAttribute("aria-describeddy","modal-description"),c.setAttribute("aria-hidden","true"),(s=c.dataset).sModalTarget="modal",s.controller="s-modal",(s=document.createElement("div")).classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(m)),s.setAttribute("role","document"),s.id="".concat(h,"-document"),s.draggable=!0,(m=document.createElement("h1")).classList.add("s-modal--header"),m.id=i,m.textContent=k,(h=document.createElement("form")).classList.add("s-modal--body","d-flex","fd-column","flex__allcells6","fw-wrap","gs16"),(i=document.createElement("button")).classList.add("s-modal--close","s-btn","s-btn__muted"),i.type="button",i.dataset.action="s-modal#hide",k=v("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),e(s.id),i.append(k),s.append(m,h,i),c.append(s),c),k=A.querySelector("form");k&&(p=new Map,document.querySelectorAll(".answer").forEach(function(e){e=t(e,"answer");e&&p.set(e.id,e)}),document.querySelectorAll(".question").forEach(function(e){e=t(e,"question");e&&p.set(e.id,e)}),m=p,h=(m=__read((h="".concat(x,"-current-posts"),i={classes:[x,"hmx2"],headers:["Type","Author","Score","Actions"],rows:__spreadArray([],__read(m),!1).map(function(e){var e=__read(e,2),t=e[0],e=e[1];return y(A,t,e)}),sortable:!0},s=void 0===(s=i.classes)?[]:s,c=i.headers,m=void 0===(m=i.rows)?[]:m,i=i.sortable,d=void 0!==i&&i,i=document.createElement("div"),(u=i.classList).add.apply(u,__spreadArray(["s-table-container"],__read(s),!1)),(u=document.createElement("table")).classList.add("s-table"),u.id=h,d&&(u.classList.add("s-table__sortable"),u.dataset.controller="s-table"),s=document.createElement("thead"),(h=document.createElement("tr")).append.apply(h,__spreadArray([],__read(c.map(function(e){var t,n,r=document.createElement("th");return r.scope="col",r.append(e),d&&((e=r.dataset).action="click->s-table#sort",e.sTableTarget="column",t=v("iconArrowUpDownSm","m7 2 4 4H3l4-4Zm0 10 4-4H3l4 4Z",__assign(__assign({},e={width:14,height:14}),{classes:["js-sorting-indicator","js-sorting-indicator-none"]})),n=v("iconArrowUpSm","M3 9h8L7 5 3 9Z",__assign(__assign({},e),{classes:["js-sorting-indicator","js-sorting-indicator-asc"],hidden:!0})),e=v("iconArrowDownSm","M3 5h8L7 9 3 5Z",__assign(__assign({},e),{classes:["js-sorting-indicator","js-sorting-indicator-desc"],hidden:!0})),r.append(t,n,e)),r})),!1)),(c=document.createElement("tbody")).append.apply(c,__spreadArray([],__read(m.map(function(e){var t=e.cells,e=e.data;return _(t,e)})),!1)),s.append(h),u.append(s,c),i.append(u),[i,u]),2))[0],g=m[1],s=(o=__read((s="".concat(x,"-search"),i=void 0===(i=(c=void 0===(c={placeholder:"Post link or text to search for",title:"Post Search",classes:["m0","mt16"]})?{}:c).classes)?[]:i,u=void 0===(u=c.placeholder)?"":u,m=void 0===(m=c.title)?"":m,c=void 0===(c=c.value)?"":c,n=document.createElement("div"),(o=n.classList).add.apply(o,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(i),!1)),(o=document.createElement("div")).classList.add("d-flex","ps-relative"),(i=document.createElement("input")).classList.add("s-input"),i.id=s,i.type="text",i.placeholder=u,i.value=c,o.append(i),n.append(o),m?((u=document.createElement("div")).classList.add("flex--item"),(c=document.createElement("label")).classList.add("d-block","s-label"),c.htmlFor=s,c.textContent=m,u.append(c),n.prepend(u),[n,i,c]):[n,i]),2))[0],w=o[1],E=new Map,w.addEventListener("input",function(){return __awaiter(void 0,void 0,void 0,function(){var r,a,o,i,s,c,d,l,u,p,m,f,v,h;return __generator(this,function(e){switch(e.label){case 0:return(r=w.value,n=r,L.test(n))?(n=r,(a=__read(/^https:.+?\/q(?:uestions)?\/(\d+)(?:\/?\d*?$)/.exec(n)||[],2)[1]||(n=r,n=__read(/^https:.+?\/(?:a\/(\d+)(?:\/?\d*?$)|questions\/.+?\/(\d+))/.exec(n)||[],3),t=n[1],n=n[2],t||n))?E.get(a)?((o=g.querySelector("[data-id=".concat(a,"]")))&&(o.hidden=!1),[2]):[4,b(a,{site:function(e){e=__read(/^https:.+?\/([^\/]+)\//.exec(e)||[],2)[1].split(".").slice(0,-1).join(".");return"meta.stackexchange"!==e?e.replace(".stackexchange",""):e}(r),filter:"7W_5I0m30",key:"pkW3HOc0hP25As5oDPVYxg(("})]:[2]):[3,2];case 1:return(o=e.sent())?(E.set(a,o),s=o.body,f=void 0===s?"":s,s=o.link,d=o.post_type,i=o.score,c=o.owner,s=y(A,a,{body:f,id:a,link:s,authorLink:null==c?void 0:c.link,authorName:null==c?void 0:c.display_name,type:d,votes:i.toString()}),c=s.cells,d=s.data,g.tBodies[0].append(_(c,d)),[2]):[2];case 2:l=g.rows;try{for(u=__values(l),p=u.next();!p.done;p=u.next())(m=p.value)!==l[0]&&(r?(f=m.dataset.body,m.hidden=!(null!=f&&f.toLowerCase().includes(r.toLowerCase()))):m.hidden=!1)}catch(e){v={error:e}}finally{try{p&&!p.done&&(h=u.return)&&h.call(u)}finally{if(v)throw v.error}}return[2]}var t,n})})}),k.append(h,s)),document.body.append(A),document.addEventListener("".concat(x,"-close-config"),function(){return Stacks.hideModal(A)}),new MutationObserver(function(n){return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=n.flatMap(function(e){return e.addedNodes}),t=t.map(function(e){e=function(e,t){var n,r;try{for(var a=__values(e),o=a.next();!o.done;o=a.next()){var i=o.value;if(i.nodeType===i.ELEMENT_NODE&&i.matches(t))return i}}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}}(e,".inline-editor");return e&&l(".js-post-editor",e)}),[4,Promise.all(t)];case 1:return e.sent().filter(r).forEach(a),[2]}})})}).observe(document,{childList:!0,subtree:!0}),m=document.createElement("style"),document.head.append(m),(f=m.sheet)&&[".".concat(x,".wmd-button > .svg-icon {\n                margin-top: 2px;\n                color: var(--black-600);\n            }"),".".concat(x,".wmd-button > .svg-icon:hover {\n                color: var(--black-900);\n            }"),".".concat(x,".s-table-container td:first-child {\n                cursor: pointer;\n            }"),".".concat(x,".s-table-container thead {\n                position: sticky;\n                top: -1px;\n                z-index: 9999;\n            }"),".s-table td {\n                border-bottom: 1px solid var(--bc-medium);\n            }"].forEach(function(e){return f.insertRule(e)})},{once:!0});