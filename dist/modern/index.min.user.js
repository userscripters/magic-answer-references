// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Make referencing other answers easier
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/magic-answer-references#readme
// @match           https://*.stackexchange.com/questions/*
// @match           https://askubuntu.com/questions/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://mathoverflow.net/questions/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.superuser.com/questions/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://serverfault.com/questions/*
// @match           https://stackapps.com/questions/*
// @match           https://stackoverflow.com/questions/*
// @match           https://superuser.com/questions/*
// @name            Magic Answer References
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/magic-answer-references.git
// @supportURL      https://github.com/userscripters/magic-answer-references/issues
// @version         2.1.1
// ==/UserScript==

"use strict";window.addEventListener("load",async()=>{const m="magic-answer-references";var e=(s,a=document)=>new Promise(t=>{var e=a.querySelector(s);e&&t(e);const n=new MutationObserver(()=>{var e=a.querySelector(s);e&&(n.disconnect(),t(e))});n.observe(a,{subtree:!0,childList:!0,attributes:!0})});const p=(e,t,n={})=>{const{classes:s=[],hidden:a=!1,namespace:o="http://www.w3.org/2000/svg",height:r=18,width:d=18}=n,i=document.createElementNS(o,"svg"),c=(i.classList.add("svg-icon",e,...s),i.setAttribute("width",d.toString()),i.setAttribute("height",r.toString()),i.setAttribute("viewBox",`0 0 ${d} `+r),i.setAttribute("aria-hidden","true"),a&&i.classList.add("d-none"),document.createElementNS(o,"path"));return c.setAttribute("d",t),i.append(c),i};const v=(e,t)=>{const n=document.createElement("tr");return Object.assign(n.dataset,t||{}),n.append(...e.map(e=>{const t=document.createElement("td");return t.append(e),t})),n};const s=(e,t)=>{var n=e.querySelector(".js-vote-count"),n=(null==(n=null==n?void 0:n.textContent)?void 0:n.trim())||"0",{answerid:s,questionid:a}=e["dataset"],s="answer"===t?s:a;if(s){var a=e.querySelector(".js-post-body");const o={body:(null==(a=null==a?void 0:a.textContent)?void 0:a.trim())||"",container:e,id:s,link:location.origin+`/${"answer"===t?"a":"q"}/`+s,type:t,votes:n};a=e.querySelector("[itemprop=author] a");return a&&(o.authorLink=a.href,o.authorName=null==(s=a.textContent)?void 0:s.trim()),a||(t=e.querySelector("[itemprop=name]"),o.authorName=null==(n=null==t?void 0:t.textContent)?void 0:n.trim()),o}console.debug(`[${m}] post is missing an id`)};const b=new RegExp("^https:.+?\\/(?:q(?:uestions)?|a)\\/\\d+(?:\\/|$)"),h=async(e,{site:t="stackoverflow",...n})=>{const s=new URL("https://api.stackexchange.com/2.3/posts/"+e),a=(s.search=new URLSearchParams({site:t,...n}).toString(),await fetch(s.toString()));var o,r,d;if(a.ok)return{items:o=[],backoff:r}=await a.json(),r?(d=1e3*r,await new Promise(e=>setTimeout(e,d)),h(e,{site:t,...n})):o[0]},l={classes:["s-btn__xs","w100"],type:"outlined",muted:!0},g=(e,u)=>{const{authorName:t,authorLink:n,body:s,container:a,type:o,votes:r}=u;var d=n&&t?((e,t)=>{const n=document.createElement("a");return n.href=e,n.title=n.textContent=t,n.target="_blank",n})(n,t):t||"";const i=document.createElement("span"),c=(i.textContent=o,i.addEventListener("click",()=>{var e,t,n,s;a&&({scrollX:e,scrollY:t}=window,{top:n,left:s}=a.getBoundingClientRect(),window.scrollTo(s+e,n+t))}),((e,t,{classes:n,title:s,danger:a=!1,loading:o=!1,muted:r,primary:d=!1,type:i})=>{const c=document.createElement("button");return c.id=e,c.textContent=t,c.classList.add("s-btn","s-btn__"+i,...n),c.setAttribute("role","button"),c.setAttribute("aria-label",s||t),a&&c.classList.add("s-btn__danger"),r&&c.classList.add("s-btn__muted"),d&&c.classList.add("s-btn__primary"),o&&c.classList.add("is-loading"),s&&(c.title=s),c})(m+"-ref-"+e,"ref",l));return c.addEventListener("click",e=>{e.preventDefault();{e=w;var t=u;const{selectionStart:i,selectionEnd:c,value:l}=e;var n=i===c,{authorLink:t,authorName:s,link:a,type:o}=t,r=l.slice(0,i+1),d=l.slice(c-1),t,s=`${(t=t?`[${s}](${t})`:s)?t+"'s ":""}[${o}](${a})`;return e.value=n?l+s:r+s+d,e.dispatchEvent(new Event("input")),void document.dispatchEvent(new CustomEvent(m+"-close-config"))}}),{cells:[i,d,r,c],data:{body:s,id:e}}};if(!document.getElementById("post-editor"))return void console.debug(`[${m}] missing post editor`);if(!await e("#wmd-button-row"))return void console.debug(`[${m}] missing editor menu`);const t=await e("#wmd-snippet-button");if(!t)return void console.debug(`[${m}] missing editor snippet button`);const w=await e("#wmd-input");if(w){const n=((e,t,n)=>{var n=n["minWidth"],s="modal-title";const a=document.createElement("aside"),o=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",s),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a)["dataset"],r=(o.sModalTarget="modal",o.controller="s-modal",document.createElement("div")),d=(r.classList.add("s-modal--dialog","ps-relative","hmx6","wmn"+n),r.setAttribute("role","document"),r.id=e+"-document",r.draggable=!0,document.createElement("h1")),i=(d.classList.add("s-modal--header"),d.id=s,d.textContent=t,document.createElement("form")),c=(i.classList.add("s-modal--body","d-flex","fd-column","flex__allcells6","fw-wrap","gs16"),document.createElement("button"));c.classList.add("s-modal--close","s-btn","s-btn__muted"),c.type="button",c.dataset.action="s-modal#hide";n=p("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z");{var u=r.id;document.addEventListener("dragstart",({dataTransfer:e})=>{const t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});let c=0,l=0,t=0,n=!1;const m=({clientX:n,clientY:s})=>{var a,o=document.getElementById(u);if(o){c=c||n,l=l||s;let{top:e,left:t}=o["style"];e||t||(a=window.getComputedStyle(o),e=a.top,t=a.left);const r=n-c,d=s-l;if(![r,d].map(Math.abs).some(e=>500<e)){const i=o["style"];i.left=parseInt(t)+r+"px",i.top=parseInt(e)+d+"px",c=n,l=s}}};document.addEventListener("dragstart",e=>{e=e.target;e===document.getElementById(u)&&(n=!0)}),document.addEventListener("dragend",({target:e})=>{e===document.getElementById(u)&&(n=!1,c=0,l=0)}),document.addEventListener("drag",e=>{if(!(3<=(t=e.clientX?0:t<3?t+1:3))&&n)return m(e)}),document.addEventListener("dragover",e=>{if(n&&e.preventDefault(),!(t<3)&&n)return m(e)})}return c.append(n),r.append(d,i,c),a.append(r),a})(m+"-config","Reference a Post",{minWidth:25}),a=n.querySelector("form");if(a){e=(()=>{const t=new Map,e=document.querySelectorAll(".answer"),n=(e.forEach(e=>{e=s(e,"answer");e&&t.set(e.id,e)}),document.querySelectorAll(".question"));return n.forEach(e=>{e=s(e,"question");e&&t.set(e.id,e)}),t})();const[o,f]=((e,t)=>{const{classes:n=[],headers:s,rows:a=[],sortable:o=!1}=t,r=document.createElement("div"),d=(r.classList.add("s-table-container",...n),document.createElement("table")),i=(d.classList.add("s-table"),d.id=e,o&&(d.classList.add("s-table__sortable"),d.dataset.controller="s-table"),document.createElement("thead")),c=document.createElement("tr"),l=(c.append(...s.map(e=>{const t=document.createElement("th");if(t.scope="col",t.append(e),o){const a=t["dataset"];a.action="click->s-table#sort",a.sTableTarget="column";var e={width:14,height:14},n=p("iconArrowUpDownSm","m7 2 4 4H3l4-4Zm0 10 4-4H3l4 4Z",{...e,classes:["js-sorting-indicator","js-sorting-indicator-none"]}),s=p("iconArrowUpSm","M3 9h8L7 5 3 9Z",{...e,classes:["js-sorting-indicator","js-sorting-indicator-asc"],hidden:!0}),e=p("iconArrowDownSm","M3 5h8L7 9 3 5Z",{...e,classes:["js-sorting-indicator","js-sorting-indicator-desc"],hidden:!0});t.append(n,s,e)}return t})),document.createElement("tbody"));return l.append(...a.map(({cells:e,data:t})=>v(e,t))),i.append(c),d.append(i,l),r.append(d),[r,d]})(m+"-current-posts",{classes:[m,"hmx2"],headers:["Type","Author","Score","Actions"],rows:[...e].map(([e,t])=>g(e,t)),sortable:!0}),[r,E]=((e,t)=>{var{classes:t=[],placeholder:n="",title:s="",value:a=""}=t;const o=document.createElement("div"),r=(o.classList.add("d-flex","gs4","gsy","fd-column",...t),document.createElement("div")),d=(r.classList.add("d-flex","ps-relative"),document.createElement("input"));if(d.classList.add("s-input"),d.id=e,d.type="text",d.placeholder=n,d.value=a,r.append(d),o.append(r),s){const i=document.createElement("div"),c=(i.classList.add("flex--item"),document.createElement("label"));return c.classList.add("d-block","s-label"),c.htmlFor=e,c.textContent=s,i.append(c),o.prepend(i),[o,d,c]}return[o,d]})(m+"-search",{placeholder:"Post link or text to search for",title:"Post Search",classes:["m0","mt16"]}),y=new Map;E.addEventListener("input",async()=>{const e=E["value"];if(n=e,b.test(n)){n=(e=>{var[,e]=/^https:.+?\/q(?:uestions)?\/(\d+)(?:\/?\d*?$)/.exec(e)||[];return e})(e)||(e=>{var[,e,t]=/^https:.+?\/(?:a\/(\d+)(?:\/?\d*?$)|questions\/.+?\/(\d+))/.exec(e)||[];return e||t})(e);if(!n)return;if(y.get(n)){const c=f.querySelector(`[data-id=${n}]`);return void(c&&(c.hidden=!1))}var t=await h(n,{site:(e=>{const[,t]=/^https:.+?\/([^\/]+)\//.exec(e)||[],n=t.split(".").slice(0,-1).join(".");return"meta.stackexchange"!==n?n.replace(".stackexchange",""):n})(e),filter:"7W_5I0m30",key:"pkW3HOc0hP25As5oDPVYxg(("});if(!t)return;y.set(n,t);const{body:a="",link:o,post_type:r,score:d,owner:i}=t;var{cells:t,data:n}=g(n,{body:a,id:n,link:o,authorLink:null==i?void 0:i.link,authorName:null==i?void 0:i.display_name,type:r,votes:d.toString()});void f.tBodies[0].append(v(t,n))}else{var s=f["rows"];for(const l of s)if(l!==s[0])if(e){const u=l["dataset"]["body"];l.hidden=!(null!==u&&void 0!==u&&u.toLowerCase().includes(e.toLowerCase()))}else l.hidden=!1}}),a.append(o,r)}document.body.append(n);e=((e,t,n,s,a)=>{const o=document.createElement("li");return o.classList.add("wmd-button",m),o.id=e,o.title=s,o.append(p(t,n)),o.addEventListener("click",a),o})(m+"-reference","iconMergeSm","M5.45 3H1v2h3.55l3.6 4-3.6 4H1v2h4.45l4.5-5H13v3l4-4-4-4v3H9.95l-4.5-5Z","Reference a post",()=>Stacks.showModal(n));t.after(e),document.addEventListener(m+"-close-config",()=>Stacks.hideModal(n));{e=document.createElement("style");document.head.append(e);const d=e["sheet"];if(d){const i=[`.${m}.wmd-button > .svg-icon {
                margin-top: 2px;
                color: var(--black-600);
            }`,`.${m}.wmd-button > .svg-icon:hover {
                color: var(--black-900);
            }`,`.${m}.s-table-container td:first-child {
                cursor: pointer;
            }`,`.${m}.s-table-container thead {
                position: sticky;
                top: -1px;
                z-index: 9999;
            }`,`.s-table td {
                border-bottom: 1px solid var(--bc-medium);
            }`];i.forEach(e=>d.insertRule(e))}}}else console.debug(`[${m}] missing editor input`)},{once:!0});