// ==UserScript==
// @name           Magic Answer References
// @author         Oleg Valter <oleg.a.valter@gmail.com>
// @description    Make referencing other answers easier
// @grant          GM_getValue
// @grant          GM_setValue
// @grant          GM_deleteValue
// @homepage       https://github.com/userscripters/magic-answer-references#readme
// @match          https://stackoverflow.com/questions/*
// @match          https://serverfault.com/questions/*
// @match          https://superuser.com/questions/*
// @match          https://*.stackexchange.com/questions/*
// @match          https://askubuntu.com/questions/*
// @match          https://stackapps.com/questions/*
// @match          https://mathoverflow.net/questions/*
// @match          https://pt.stackoverflow.com/questions/*
// @match          https://ja.stackoverflow.com/questions/*
// @match          https://ru.stackoverflow.com/questions/*
// @match          https://es.stackoverflow.com/questions/*
// @match          https://meta.stackoverflow.com/questions/*
// @match          https://meta.serverfault.com/questions/*
// @match          https://meta.superuser.com/questions/*
// @match          https://meta.askubuntu.com/questions/*
// @match          https://meta.mathoverflow.net/questions/*
// @match          https://pt.meta.stackoverflow.com/questions/*
// @match          https://ja.meta.stackoverflow.com/questions/*
// @match          https://ru.meta.stackoverflow.com/questions/*
// @match          https://es.meta.stackoverflow.com/questions/*
// @namespace      userscripters
// @require        https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at         document-start
// @source         git+https://github.com/userscripters/magic-answer-references.git
// @supportURL     https://github.com/userscripters/magic-answer-references/issues
// @version        2.2.2
// ==/UserScript==

"use strict";window.addEventListener("load",()=>{const y="magic-answer-references",i=(n,s=document)=>new Promise(t=>{var e=s.querySelector(n);e&&t(e);const a=new MutationObserver(()=>{var e=s.querySelector(n);e&&(a.disconnect(),t(e))});a.observe(s,{subtree:!0,childList:!0,attributes:!0})}),t=e=>!!e,c=(e,t,a={})=>{var{classes:a=[],hidden:n=!1,namespace:s="http://www.w3.org/2000/svg",height:d=18,width:o=18}=a,r=document.createElementNS(s,"svg"),e=(r.classList.add("svg-icon",e,...a),r.setAttribute("width",o.toString()),r.setAttribute("height",d.toString()),r.setAttribute("viewBox",`0 0 ${o} `+d),r.setAttribute("aria-hidden","true"),n&&r.classList.add("d-none"),document.createElementNS(s,"path"));return e.setAttribute("d",t),r.append(e),r};const u=(e,t)=>{var a=document.createElement("tr");return Object.assign(a.dataset,t||{}),a.append(...e.map(e=>{var t=document.createElement("td");return t.append(e),t})),a};const a=(e,t)=>{var a=e.querySelector(".js-vote-count"),a=(null==(a=null==a?void 0:a.textContent)?void 0:a.trim())||"0",{answerid:n,questionid:s}=e["dataset"],n="answer"===t?n:s;if(n)return s={body:(null==(s=null==(s=e.querySelector(".js-post-body"))?void 0:s.textContent)?void 0:s.trim())||"",container:e,id:n,link:location.origin+`/${"answer"===t?"a":"q"}/`+n,type:t,votes:a},(n=e.querySelector("[itemprop=author] a"))&&(s.authorLink=n.href,s.authorName=null==(t=n.textContent)?void 0:t.trim()),n||(a=e.querySelector("[itemprop=name]"),s.authorName=null==(t=null==a?void 0:a.textContent)?void 0:t.trim()),s;console.debug(`[${y}] post is missing an id`)};const m=new RegExp("^https:.+?\\/(?:q(?:uestions)?|a)\\/\\d+(?:\\/|$)"),p=async(e,{site:t="stackoverflow",...a})=>{var n,s,d=new URL("https://api.stackexchange.com/2.3/posts/"+e),d=(d.search=new URLSearchParams({site:t,...a}).toString(),await fetch(d.toString()));if(d.ok)return{items:d=[],backoff:n}=await d.json(),n?(s=1e3*n,await new Promise(e=>setTimeout(e,s)),p(e,{site:t,...a})):d[0]},L={classes:["s-btn__xs","w100"],type:"outlined",muted:!0},v=(c,e,u)=>{const{authorName:t,authorLink:a,body:n,container:s,type:d,votes:o}=u;var r,i,l,m,p,v,b,h,g,w=a&&t?(w=a,E=t,(r=document.createElement("a")).href=w,r.title=r.textContent=E,r.target="_blank",r):t||"",E=document.createElement("span"),f=(E.textContent=d,E.addEventListener("click",()=>{var e,t,a,n;s&&({scrollX:e,scrollY:t}=window,{top:a,left:n}=s.getBoundingClientRect(),window.scrollTo(n+e,a+t))}),[r,i,{classes:l,title:m,danger:p=!1,loading:v=!1,muted:b,primary:h=!1,type:f}]=[y+"-ref-"+e,"ref",L],(g=document.createElement("button")).id=r,g.textContent=i,g.classList.add("s-btn","s-btn__"+f,...l),g.setAttribute("role","button"),g.setAttribute("aria-label",m||i),p&&g.classList.add("s-btn__danger"),b&&g.classList.add("s-btn__muted"),h&&g.classList.add("s-btn__primary"),v&&g.classList.add("is-loading"),m&&(g.title=m),g);return f.addEventListener("click",e=>{e.preventDefault();var t,a,n,s,d,o,r,i,l,e=c.dataset["currentEditorId"];e?(t=document.getElementById(e))&&((a=t.querySelector(".js-post-body-field"))?(n=u,{selectionStart:r,selectionEnd:l,value:i}=a=a,{authorLink:n,authorName:s,link:d,type:o}=n,r=i.slice(0,r),i=i.slice(l),l=n?`[${s}](${n})`:s,a.value=r+`${l?l+"'s ":""}[${o}](${d})`+i,a.dispatchEvent(new Event("input")),document.dispatchEvent(new CustomEvent(y+"-close-config"))):console.debug(`[${y}] missing editor input (${t})`)):console.debug(`[${y}] missing editor (${e})`)}),{cells:[E,w,o,f],data:{body:n,id:e}}},n=async e=>{var t,a,n,s,d,o,r;e?await i(".wmd-button-row",e)?(t=await i(".wmd-spacer2",e))?(a=y+"-reference",n="iconMergeSm",s="M5.45 3H1v2h3.55l3.6 4-3.6 4H1v2h4.45l4.5-5H13v3l4-4-4-4v3H9.95l-4.5-5Z",d="Reference a post",o=()=>{b.dataset.currentEditorId=e.id,Stacks.showModal(b)},(r=document.createElement("li")).classList.add("wmd-button",y),r.id=a,r.title=d,r.append(c(n,s)),r.addEventListener("click",o),a=r,t.before(a)):console.debug(`[${y}] missing .wmd-spacer2 element`):console.debug(`[${y}] missing editor menu`):console.debug(`[${y}] missing post editor`)};var e=document.getElementById("post-editor");n(e);const b=((e,t,a)=>{var a=a["minWidth"],n="modal-title",s=document.createElement("aside"),d=(s.classList.add("s-modal"),s.id=e,s.tabIndex=-1,s.setAttribute("role","dialog"),s.setAttribute("aria-labelledby",n),s.setAttribute("aria-describeddy","modal-description"),s.setAttribute("aria-hidden","true"),s)["dataset"],d=(d.sModalTarget="modal",d.controller="s-modal",document.createElement("div")),a=(d.classList.add("s-modal--dialog","ps-relative","hmx6","wmn"+a),d.setAttribute("role","document"),d.id=e+"-document",d.draggable=!0,document.createElement("h1")),e=(a.classList.add("s-modal--header"),a.id=n,a.textContent=t,document.createElement("form")),n=(e.classList.add("s-modal--body","d-flex","fd-column","flex__allcells6","fw-wrap","gs16"),document.createElement("button")),t=(n.classList.add("s-modal--close","s-btn","s-btn__muted"),n.type="button",n.dataset.action="s-modal#hide",c("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"));{var l=d.id;document.addEventListener("dragstart",({dataTransfer:e})=>{var t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});let r=0,i=0,t=0,a=!1;const o=({clientX:a,clientY:n})=>{var s=document.getElementById(l);if(s){r=r||a,i=i||n;let{top:e,left:t}=s["style"];e||t||(d=window.getComputedStyle(s),e=d.top,t=d.left);var d=a-r,o=n-i;[d,o].map(Math.abs).some(e=>500<e)||(s=s["style"],s.left=parseInt(t)+d+"px",s.top=parseInt(e)+o+"px",r=a,i=n)}};document.addEventListener("dragstart",e=>{e=e.target;e===document.getElementById(l)&&(a=!0)}),document.addEventListener("dragend",({target:e})=>{e===document.getElementById(l)&&(a=!1,r=0,i=0)}),document.addEventListener("drag",e=>{if(!(3<=(t=e.clientX?0:t<3?t+1:3))&&a)return o(e)}),document.addEventListener("dragover",e=>{if(a&&e.preventDefault(),!(t<3)&&a)return o(e)})}return n.append(t),d.append(a,e,n),s.append(d),s})(y+"-config","Reference a Post",{minWidth:25});e=b.querySelector("form");if(e){var s=(()=>{const t=new Map;return document.querySelectorAll(".answer").forEach(e=>{e=a(e,"answer");e&&t.set(e.id,e)}),document.querySelectorAll(".question").forEach(e=>{e=a(e,"question");e&&t.set(e.id,e)}),t})();const[d,h]=((e,t)=>{const{classes:a=[],headers:n,rows:s=[],sortable:d=!1}=t;var t=document.createElement("div"),o=(t.classList.add("s-table-container",...a),document.createElement("table")),e=(o.classList.add("s-table"),o.id=e,d&&(o.classList.add("s-table__sortable"),o.dataset.controller="s-table"),document.createElement("thead")),r=document.createElement("tr"),i=(r.append(...n.map(e=>{var t,a,n=document.createElement("th");return n.scope="col",n.append(e),d&&(e=n["dataset"],e.action="click->s-table#sort",e.sTableTarget="column",e={width:14,height:14},t=c("iconArrowUpDownSm","m7 2 4 4H3l4-4Zm0 10 4-4H3l4 4Z",{...e,classes:["js-sorting-indicator","js-sorting-indicator-none"]}),a=c("iconArrowUpSm","M3 9h8L7 5 3 9Z",{...e,classes:["js-sorting-indicator","js-sorting-indicator-asc"],hidden:!0}),e=c("iconArrowDownSm","M3 5h8L7 9 3 5Z",{...e,classes:["js-sorting-indicator","js-sorting-indicator-desc"],hidden:!0}),n.append(t,a,e)),n})),document.createElement("tbody"));return i.append(...s.map(({cells:e,data:t})=>u(e,t))),e.append(r),o.append(e,i),t.append(o),[t,o]})(y+"-current-posts",{classes:[y,"hmx2"],headers:["Type","Author","Score","Actions"],rows:[...s].map(([e,t])=>v(b,e,t)),sortable:!0}),[o,g]=((e,t)=>{var{classes:t=[],placeholder:a="",title:n="",value:s=""}=t,d=document.createElement("div"),t=(d.classList.add("d-flex","gs4","gsy","fd-column",...t),document.createElement("div")),o=(t.classList.add("d-flex","ps-relative"),document.createElement("input"));return o.classList.add("s-input"),o.id=e,o.type="text",o.placeholder=a,o.value=s,t.append(o),d.append(t),n?((a=document.createElement("div")).classList.add("flex--item"),(s=document.createElement("label")).classList.add("d-block","s-label"),s.htmlFor=e,s.textContent=n,a.append(s),d.prepend(a),[d,o,s]):[d,o]})(y+"-search",{placeholder:"Post link or text to search for",title:"Post Search",classes:["m0","mt16"]}),w=new Map;g.addEventListener("input",async()=>{var e=g["value"];if(o=e,m.test(o)){var t,a,n,s,d,o=(e=>{var[,e]=/^https:.+?\/q(?:uestions)?\/(\d+)(?:\/?\d*?$)/.exec(e)||[];return e})(e)||(e=>{var[,e,t]=/^https:.+?\/(?:a\/(\d+)(?:\/?\d*?$)|questions\/.+?\/(\d+))/.exec(e)||[];return e||t})(e);o&&(w.get(o)?(d=h.querySelector(`[data-id=${o}]`))&&(d.hidden=!1):(d=await p(o,{site:(e=>{var[,e]=/^https:.+?\/([^\/]+)\//.exec(e)||[],e=e.split(".").slice(0,-1).join(".");return"meta.stackexchange"!==e?e.replace(".stackexchange",""):e})(e),filter:"7W_5I0m30",key:"pkW3HOc0hP25As5oDPVYxg(("}))&&(w.set(o,d),{body:d="",link:t,post_type:a,score:n,owner:s}=d,{cells:d,data:o}=v(b,o,{body:d,id:o,link:t,authorLink:null==s?void 0:s.link,authorName:null==s?void 0:s.display_name,type:a,votes:n.toString()}),h.tBodies[0].append(u(d,o))))}else{var r,i=h["rows"];for(const l of i)l!==i[0]&&(e?({body:r}=l["dataset"],l.hidden=!(null!=r&&r.toLowerCase().includes(e.toLowerCase()))):l.hidden=!1)}}),e.append(d,o)}document.body.append(b),document.addEventListener(y+"-close-config",()=>Stacks.hideModal(b)),new MutationObserver(async e=>{e=e.flatMap(({addedNodes:e})=>e).map(e=>{e=((e,t)=>{for(const n of e)if((a=n).nodeType===a.ELEMENT_NODE&&n.matches(t))return n;var a})(e,".inline-editor");return e&&i(".js-post-editor",e)});(await Promise.all(e)).filter(t).forEach(n)}).observe(document,{childList:!0,subtree:!0});{s=document.createElement("style"),document.head.append(s);const r=s["sheet"];r&&[`.${y}.wmd-button > .svg-icon {
                margin-top: 2px;
                color: var(--black-600);
            }`,`.${y}.wmd-button > .svg-icon:hover {
                color: var(--black-900);
            }`,`.${y}.s-table-container td:first-child {
                cursor: pointer;
            }`,`.${y}.s-table-container thead {
                position: sticky;
                top: -1px;
                z-index: 9999;
            }`,`.s-table td {
                border-bottom: 1px solid var(--bc-medium);
            }`].forEach(e=>r.insertRule(e))}},{once:!0});